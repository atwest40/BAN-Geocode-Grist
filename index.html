<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Grist Geocoder Widget</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #results { margin-top: 1em; }
  </style>
</head>
<body>
  <h2>Geocode Address (BAN API)</h2>
  <div id="inputField">Waiting for address...</div>
  <div id="results"></div>

  <script>
    window.addEventListener("message", async (event) => {
      const address = event.data?.records?.[0]?.fields?.Address;
      if (!address) return;

      document.getElementById('inputField').innerText = `Address: ${address}`;
      const res = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(address)}&limit=1`);
      const data = await res.json();

      const feature = data.features?.[0];
      if (feature) {
        const props = feature.properties;
        document.getElementById('results').innerHTML = `
          <strong>City:</strong> ${props.city}<br>
          <strong>Postcode:</strong> ${props.postcode}<br>
          <strong>INSEE code:</strong> ${props.citycode}<br>
          <strong>Coordinates:</strong> ${feature.geometry.coordinates.join(', ')}
        `;
      } else {
        document.getElementById('results').innerHTML = `<em>No results found.</em>`;
      }
    }, false);
  </script>
</body>
</html>
